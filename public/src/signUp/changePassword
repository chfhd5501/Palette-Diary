<?php
//to solve cors issue
header("Access-Control-Allow-Origin: *");

 //db connect
$host = "localhost";
$s_username = "db";
$s_password = "dbpassword";
$dbname = "palette_diary";
$conn = mysqli_connect($host, $s_username, $s_password, $dbname);

//var for func
$user_type = "user";

try{
  $json = json_decode(file_get_contents('php://input'), TRUE);

  $password = $json['password'];
  $changePassword = $json['changePassword'];
  $error = "none";
  $stat = "none";

  $checkingEmailExistSql="select * from user where email='$email'"; // jwt 이메일 or sql문
  $checkingEmailExistResult = mysqli_fetch_assoc(mysqli_query($conn, $checkingEmailExistSql));
  $db_password = $EmailExistResultRecord["password"];
  mysqli_close($conn);

  /*if(empty($checkingEmailExistResult)==true) { //null이라면
    throw new exception('email has not exist', 401);
    exit();
  }*/

  if(password_verify($password, $db_password)) { // 비밀번호 일치
    // 변경할 비밀번호 암호화해서 insert
    $encrypted_password = password_hash($changePassword, PASSWORD_DEFAULT); //password 암호화

    $insertUserSql = "insert into user(email, password, user_type) values('$email', '$encrypted_password', '$user_type');";
    // $insertUserSql = "insert into user(email, password, user_type) values('$email', sha1('$password'), '$user_type');"; //DB제공
    $insertResult = mysqli_query($conn, $insertUserSql);

  }
  else {
    throw new exception('password not equal', 402);
    exit();
  }

  

  if($insertResult){
    $stat = "success";
  }
  else{
    throw new exception('cant insert user', 400);
  }
}catch(exception $e) {
  $stat   = "error";
  $error = ['errorMsg'   => $e->getMessage(), 'errorCode' => $e->getCode()];
}finally{
  $data =  json_encode(['result_code' => $stat, 'error'=>$error]);
  header('Content-type: application/json'); 
  echo $data;
}
mysqli_close($conn);
?>
