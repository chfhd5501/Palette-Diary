<?php
//to solve cors issue
header("Access-Control-Allow-Origin: ");

//db connect
$host = "localhost";
$s_username = "db";
$s_password = "dbpassword";
$dbname = "palette_diary";
$conn = mysqli_connect($host, $s_username, $s_password, $dbname);

try{
    $json = json_decode(file_get_contents('php://input'), TRUE);

    $cookie = apache_request_headers()['Cookie'];
    $email = json_decode(base64_decode(str_replace('_', '/', str_replace('-', '+', explode('.', explode("=", $cookie)[1])[1]))), TRUE)['email'];
    $error = "none";
    $stat = "none";

    $selectDiaryCode = $json['diary_code'];

    $selectHappyDiaryInfoSql = "select * from happy_diary left join diary on happy_diary.diary_code = diary.diary_code where happy_diary.diary_code='$selectDiaryCode' and email='$email';";
    $selectHappyDiaryInfoResult = mysqli_fetch_assoc(mysqli_query($conn, $selectHappyDiaryInfoSql));

    if(empty($selectHappyDiaryInfoResult)==true) {
        throw new exception('해당 일기는 해피 저금통에 저금되어 있지 않습니다.', 404);
    }
    else {
        $dbDiaryCode = $selectHappyDiaryInfoResult['diary_code'];
        $dbDiaryDate = $selectHappyDiaryInfoResult['d_date'];
        $dbDiaryColor = $selectHappyDiaryInfoResult['color'];
        $dbDiaryKeyword = $selectHappyDiaryInfoResult['keyword'];
        $dbDiaryMainPic = $selectHappyDiaryInfoResult['mainPic'];
        $dbDiaryBody = $selectHappyDiaryInfoResult['diary_body'];

        $dbDiaryDate = substr($dbDiaryDate,0,9);

        //파일

        $fileName = explode("/", $dbDiaryMainPic);
        $fileName = $fileName[3];

        $imgLink = "125.140.42.36".$fileName; //DB 경로에 들어있는 사진을 ftp 서버에서 찾기
        file_get_contents($imgLink);
        file_put_contents("./userProfile/".$fileName, $fileName); // 경로에 해당 파일 put

        $stat="success";
    }
    mysqli_close($conn);

}catch(exception $e) {
    $stat   = "error";
    $error = ['errorMsg' => $e->getMessage(), 'errorCode' => $e->getCode()];
}finally{
    $data =  json_encode(['diary_code' => $dbDiaryCode, 'd_date' => $dbDiaryDate, 'color' => $dbDiaryColor, 'keyword' => $dbDiaryKeyword, 'mainPic' => "./userProfile/".$fileName, 'diary_body' => $dbDiaryBody, 'result_code' => $stat, 'error'=>$error]);
    header('Content-type: application/json'); 
    echo $data;
}
?>
